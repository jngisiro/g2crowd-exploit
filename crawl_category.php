<?php
require_once('settings.php');
require_once('crawl_utils.php');

if ( !isset ( $connection ) ) {
	$connection = new mysqli( DB_HOST, DB_USER, DB_PASSWORD, G2_DB_NAME );
	if ( $connection->connect_error ) {
		die ( "Couldn't Connect To DB");
	}
}

/*
$query = "select url,name from (select * from (SELECT s.id soft_id,s.name soft_name,sc.id,sc.name,sc.url FROM `softwares` s,software_category_mapping scm,software_category sc where sc.id=scm.category_id and reward = 15 and scm.soft_id = s.id  order by s.id, sc.id desc)a group by a.soft_id)b group by b.name";
if(!$result=$connection->query($query)){
	die("error");
}
*/

$url = 'https://www.g2crowd.com/categories/project-portfolio-management-ppm/products';
//$pages = get_cat_pagination($url);
//echo "No. of Pages found $pages".PHP_EOL;
//sleep(20);

for($i=1; $i<=1; $i++){
	if($i == '10'){
		break;
	}

	$softwares = crawl_category_url($url."?order=popular&page=$i");

	foreach($softwares as $software){
		$query = "insert ignore into softwares (id, name) values ('{$software['id']}', '{$software['name']}')";
		if(!$connection->query($query)){
			die("error");
		}
	}

	sleep(20);
}

?>
