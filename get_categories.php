<?php
require_once('settings.php');
require_once('crawl_utils.php');
require_once('split_utils.php');

if ( !isset ( $connection ) ) {
	$connection = new mysqli( DB_HOST, DB_USER, DB_PASSWORD, G2_DB_NAME );
	if ( $connection->connect_error ) {
		die ( "Couldn't Connect To DB");
	}
}

$query = "select * from softwares where category_mapping = '0' and crawled=1 order by id";
if(!$result=$connection->query($query)){
	die("error");
}

while($row = $result->fetch_assoc()){

	$url = str_replace(' ', '-', strtolower($row['name']));
	$url = "https://www.g2crowd.com/products/$url/reviews";

	$cats = get_categories($url);

	foreach($cats as $key=>$cat){
		if($key == 0){
			$parent_id = 0;
		}else{
			$parent_id = $last_cat_id;
		}

		$query = "insert ignore into software_category (name, url, parent_id) values ('{$cat['name']}', '{$cat['url']}', '$parent_id')";
		if(!$connection->query($query)){
			die("error");
		}

		$query = "select id from software_category where name='{$cat['name']}'";
		if(!$cat_id = $connection->query($query)){
			die("error");
		}
		$cat_id = $cat_id->fetch_assoc();
		$last_cat_id = $cat_id['id'];

		$query = "insert ignore into software_category_mapping (category_id, soft_id) values ('{$cat_id['id']}', '{$row['id']}')";
		if(!$connection->query($query)){
			die("error");
		}
	}

	$query = "update softwares set category_mapping = '1' where id = '{$row['id']}'";
	if(!$connection->query($query)){
		die("error");
	}
}
