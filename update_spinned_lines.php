<?php
define( 'CHAR_LIMIT', 10000 );

require_once('split_utils.php');
require_once('settings.php');
require_once('spin_text.php');

if ( !isset ( $connection ) ) {
	$connection = new mysqli( DB_HOST, DB_USER, DB_PASSWORD, G2_DB_NAME );
	if ( $connection->connect_error ) {
		die ( "Couldn't Connect To DB");
	}
}

if (isset($_GET['soft_id']) && isset($_GET['type'])) {
	spin_software($_GET['soft_id'], $_GET['type']);
	echo 'done<br>';
	echo "<a target=\"_blank\" href=\"http://siteremoved.in/g2crowd/generate_review.php?soft_id={$_GET['soft_id']}\">Generate Reviews Here</a>";
}else{
	echo 'url should look like this:<br>';
	echo 'http://siteremoved.in/g2crowd/update_spinned_lines.php?soft_id=123&type=1<br>';
	echo 'where type is 1 for like, 2 for disklike and 3 for reco.';
}

function spin_software($soft_id, $type){
	global $connection;

	if(empty($soft_id) || empty($type)){
		die('params missing - spin_software');
	}

	$orig_lines = array();
	$query = "select se.orig_sentence, so.name from sentences se, softwares so where so.id=se.software_id and so.id = '$soft_id' and se.type_id='$type' and spinned_sentence=''";
	if(!$result=$connection->query($query)){
		die("error");
	}

	if($result->num_rows == '0'){
		echo "got no new line to spin<br>";
		return;
	}

	$para = '';
	$spinned_para = '';
	while($row = $result->fetch_assoc()){
		$orig_lines[] = $row['orig_sentence'];

		if((strlen($para) + strlen($row['orig_sentence'])) <= CHAR_LIMIT){
			$para .= '|| '.$row['orig_sentence'].' ';
		}else{
			$para = trim($para);
			$soft_name = $row['name'];
			$spinned_para .= spin_text($para, $soft_name).' ';
			$para = '|| '.$row['orig_sentence'].' ';
		}
	}

	if(!empty($para)){
		$para = trim($para);
		$soft_name = $row['name'];
		$spinned_para .= spin_text($para, $soft_name);
	}

	$spinned_para = trim($spinned_para);
	$spinned_lines = get_lines($spinned_para, '||');

	update_spinned_lines($orig_lines, $spinned_lines, $soft_id, $type);
}

function update_spinned_lines($orig_lines, $spinned_lines, $soft_id, $type){
	if(empty($soft_id) || empty($type) || empty($orig_lines) || empty($spinned_lines)){
		die('params missing');
	}

	global $connection;

	if(count($orig_lines) == count($spinned_lines)){

		$i = 0;
		foreach($spinned_lines as $line){
			$query = "Update `sentences` set `spinned_sentence` = '".$connection->escape_string($line)."' where software_id='$soft_id' and type_id='$type' and orig_sentence='".$connection->escape_string($orig_lines[$i])."'";
			if(!$result=$connection->query($query)){
				die("error putting lines");
			}
			$i++;
		}
	}else{
		echo $soft_id.PHP_EOL.$type.PHP_EOL;
		echo('we have a problem');
		return;
	}
}
