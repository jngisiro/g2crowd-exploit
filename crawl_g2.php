<?php
require_once('settings.php');
require_once('crawl_utils.php');
require_once('split_utils.php');
require_once('update_spinned_lines.php');

if ( !isset ( $connection ) ) {
	$connection = new mysqli( DB_HOST, DB_USER, DB_PASSWORD, G2_DB_NAME );
	if ( $connection->connect_error ) {
		die ( "Couldn't Connect To DB");
	}
}

$query = "select * from softwares where crawled=0";
if(!$result=$connection->query($query)){
	die("error");
}

while($row = $result->fetch_assoc()){
	echo "Crawling {$row['name']}".PHP_EOL;

	$url = str_replace(' ', '-', trim(strtolower($row['name'])));
	$url = "https://www.g2crowd.com/products/$url/reviews";

	$pages = get_pagination($url);
	echo "No. of Pages found $pages".PHP_EOL;
	sleep(10);

	for($i=1; $i<=$pages; $i++){
		if($i == '10'){
			break;
		}

		list($likes, $dislikes, $business) = crawl_software_url($url."?page=$i");

		if(!empty($likes)){
			import_paras($likes, $row['id'], '1');
			import_paras($dislikes, $row['id'], '2');
			import_paras($business, $row['id'], '3');

		}else if($i == '1'){
			$pages = 0;
		}

		sleep(20);
	}

	$query = "update softwares set pages=$pages, crawled=1 where id='{$row['id']}'";
	if(!$connection->query($query)){
		die("error");
	}

	spin_software($row['id'], '1');
	spin_software($row['id'], '2');
	spin_software($row['id'], '3');
	
	exec("php get_categories.php");
}

$connection->close();

function import_paras($paras, $soft_id, $type){
	global $connection;

	$para =	get_para($paras);
	$lines = get_lines($para);

	foreach($lines as $line){
		if(str_word_count($line) <= 3){
			continue;
		}

		$query = "INSERT ignore INTO `sentences`(`orig_sentence`, `software_id`, `type_id`) VALUES ('".$connection->escape_string($line)."','$soft_id','$type')";
		if(!$result=$connection->query($query)){
			die("error putting lines");
		}
	}
}
