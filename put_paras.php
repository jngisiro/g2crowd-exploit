<?php
define( 'CACHE_ROOT', '/tmp/' );

require_once('settings.php');
require_once('split_utils.php');

if ( !isset ( $connection ) ) {
	$connection = new mysqli( DB_HOST, DB_USER, DB_PASSWORD, G2_DB_NAME );
	if ( $connection->connect_error ) {
		die ( "Couldn't Connect To DB");
	}
}


if (isset($_POST["submit"]) && isset($_POST['soft_name']) && isset($_POST['line_type'])) {

	$query = "select id from softwares where name = '{$_POST['soft_name']}'";
	if(!$result=$connection->query($query)){
		die("error getting softid");
	}
	$row = $result->fetch_assoc();
	$_POST['soft_id'] = $row['id'];

	if ( isset($_FILES["file"])) {
		$temp_name = $_FILES["file"]["tmp_name"];

		//Check if method was POST with which the file was uploaded.
		if( !empty($temp_name) && is_uploaded_file( $temp_name )){

			//file type should be txt/csv
			if($_FILES["file"]["type"] != 'text/plain'){
				echo 'File type error.';
				exit();
			}

			//file size shouldn't exceed 4mb
			$file_size = $_FILES["file"]["size"]/(1024*1024);
			if($file_size > 4){
				echo 'File size exceeded.';
				exit();
			}

			//if there was an error uploading the file
			if ($_FILES["file"]["error"] > 0) {
				echo "Return Code: " . $_FILES["file"]["error"] . "<br />";
				exit();
			}
			else {
				$storagename = $_FILES["file"]["name"];
				move_uploaded_file($temp_name, CACHE_ROOT . $storagename);
			}
		}else{
			echo "you trynna hack me bro?";
			exit();
		}
	} else {
		echo "No file selected <br />";
		exit();
	}

	import_sentences(CACHE_ROOT.$storagename, $_POST['soft_id'], $_POST['line_type']);
	echo 'done<br>';
	echo "<a target=\"_blank\" href=\"http://siteremoved.in/g2crowd/update_spinned_lines.php?soft_id={$_POST['soft_id']}&type={$_POST['line_type']}\">Update Spinned Lines Here</a>";
	exit();
}

function import_sentences($file, $soft_id, $type){
	global $connection;

	$para = file_get_contents($file);
	$lines = get_lines($para);

	foreach($lines as $line){
		$query = "INSERT ignore INTO `sentences`(`orig_sentence`, `software_id`, `type_id`) VALUES ('".$connection->escape_string($line)."','$soft_id','$type')";
		if(!$result=$connection->query($query)){
			die("error putting lines");
		}
	}
}

?>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=utf-8">

<link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
<link rel="stylesheet" href="/resources/demos/style.css">

<script>
$(function() {
		<?php
		$query = "select * from softwares";
		$result = $connection->query($query);
		$softs ="[";

		while($row = $result->fetch_assoc()){
			$softs.= '"'.$row['name'].'",';
		}

		$softs = trim($softs, ",");
		$softs.=']';

		echo "  var availableSubs = ".$softs;
		?>

		$( "#soft_name" ).autocomplete({
			source: availableSubs
		});
	});
</script>
</head>

<body>

<table width="600">
<form action="<?php echo $_SERVER["PHP_SELF"]; ?>" method="post" enctype="multipart/form-data">
<div>Software Name: <input type="text" name="soft_name" id="soft_name"></div>

Para Type:
<select name="line_type" id="line_type">
<option selected value="1">like</option>
<option value="2">dislike</option>
<option value="3">business</option>
</select>

<tr>
<td width="80%">Select text file containing para</td>
<td width="80%"><input type="file" name="file" id="file" /></td>
</tr>

<tr>
<td>Submit</td>
<td><input type="submit" name="submit" /></td>
</tr>

</form>
</table>

<?php $connection->close(); ?>
