<?php
define('RANDOM_LINES_COUNT', 5);
require_once('settings.php');
require_once('split_utils.php');

if ( !isset ( $connection ) ) {
	$connection = new mysqli( DB_HOST, DB_USER, DB_PASSWORD, G2_DB_NAME );
	if ( $connection->connect_error ) {
		die ( "Couldn't Connect To DB");
	}
}

if (isset($_POST['used_lines']) && $_POST['used_lines'] == 'true') {
	$used_lines = array();
	$used_lines['1'] = get_lines_without_clean($_POST['used_likes']);
	$used_lines['2'] = get_lines_without_clean($_POST['used_dislikes']);
	$used_lines['3'] = get_lines_without_clean($_POST['used_business']);

	foreach($used_lines as $type=>$lines){
		foreach($lines as $line){
			if(!empty($line)){
				$query = "Update `sentences` set `used` = 1 where software_id in ({$_POST['soft_ids']}) and type_id='$type' and spinned_sentence='".$connection->escape_string($line)."'";
				if(!$result=$connection->query($query)){
					die("error updating used lines");
				}
			}
		}
	}

	echo 'lines updated<br>';
	echo "<a href=\"http://siteremoved.in/g2crowd/generate_cat_review.php?cat_id={$_POST['cat_id']}\">Generate more reviews here</a>";
	exit;
}

if (isset($_GET['cat_name']) || isset($_GET['cat_id'])) {

	if(isset($_GET['cat_name'])){
		$query = "select id from software_category where name = '{$_GET['cat_name']}'";
		if(!$result=$connection->query($query)){
			die("error getting catid");
		}
		$row = $result->fetch_assoc();
		$_GET['cat_id'] = $row['id'];
	}

	$query = "SELECT soft_id, se.spinned_sentence, se.used, se.type_id, sc.name, so.name as software_name, so.reward FROM software_category sc join software_category_mapping scm on sc.id = scm.category_id and sc.id='{$_GET['cat_id']}' join softwares so on so.id=scm.soft_id left join sentences se on so.id=se.software_id";
	if(!$result=$connection->query($query)){
		die("error");
	}

	if($result->num_rows == '0'){
		die("got no new unused lines");
	}

	$likes = array();
	$dislikes = array();
	$business = array();
	$softwares = array();
	$soft_ids = array();
	$reward = array();
	$lines_count = 0;
	while($row = $result->fetch_assoc()){

		if(!empty($row['spinned_sentence']) && $row['used']=='0'){
			switch ($row['type_id']) {
				case '1':
					$likes[] = $row['spinned_sentence'];
					break;
				case '2':
					$dislikes[] = $row['spinned_sentence'];
					break;
				case '3':
					$business[] = $row['spinned_sentence'];
					break;
				default:
					break;
			}

			$lines_count++;
		}

		$category_name = $row['name'];
		$softwares[] = $row['software_name'];
		$soft_ids[] = $row['soft_id'];
		if($row['reward'] == '15'){
			$reward[$row['software_name']] = $row['reward'];
		}
	}

	$likes_text = get_para(get_random_lines($likes, RANDOM_LINES_COUNT));
	$dislikes_text = get_para(get_random_lines($dislikes, RANDOM_LINES_COUNT));
	$business_text = get_para(get_random_lines($business, RANDOM_LINES_COUNT));

?>
<!DOCTYPE html>
<html>

<head>
  <title><?php echo $category_name;?> Review</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap -->
  <link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
  <link rel="stylesheet" href="css/chosen.css" />
  <script src="http://code.jquery.com/jquery.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <script>
  tinymce.init({
    selector: "textarea",
    plugins: [
    "advlist autolink lists link image charmap print preview anchor",
    "searchreplace visualblocks code fullscreen",
    ],
    toolbar: "insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image",
    autosave_ask_before_unload: true,
    max_height: 200,
    min_height: 160,
    height : 160
  });
  </script>
  <script>
  $(document).ready( function() {
    jQuery(".chosen").chosen();
  });

</script>
<style>
.chosen{
  width: 450px;
}
</style>
</head>
<body>
  <div class="row-fluid">
    <center>
      <h3><?php echo $category_name;?> Review</h3>
<br>
	<?php 
	$softwares = array_unique($softwares);
	$software_name = array();
	foreach($softwares as $software){
		if(array_key_exists($software, $reward)){
			$software_name[] = '<a target="_blank" href="http://siteremoved.in/g2crowd/generate_review.php?soft_name='.$software.'"><strong>'.$software.'</strong></a>';
		}else{
			$software_name[] = '<a target="_blank" href="http://siteremoved.in/g2crowd/generate_review.php?soft_name='.$software.'">'.$software.'</a>';
		}
	}
	echo implode(', ', array_unique($software_name));
	?>
<br>
No. of remaining unused lines under this category <?php echo $lines_count; ?>

    </center>
    <br>
    <br>
    <form class="form-horizontal" method="post" action="<?php echo $_SERVER["PHP_SELF"]; ?>" name="my_form">
	<div class="row">
              <div class="form-group">
                <label for="extrainfo" class="col-lg-2 control-label">LIKES:</label>
                <div class="col-lg-8">
                  <textarea name="used_likes" rows=8 cols=100 wrap="soft"><?php echo trim($likes_text); ?> </textarea>
                </div>
              </div>
        </div>
	<div class="row">
              <div class="form-group">
                <label for="extrainfo" class="col-lg-2 control-label">DISLIKES:</label>
                <div class="col-lg-8">
                  <textarea name="used_dislikes" rows=8 cols=100 wrap="soft"><?php echo trim($dislikes_text); ?> </textarea>
                </div>
              </div>
        </div>
	<div class="row">
              <div class="form-group">
                <label for="extrainfo" class="col-lg-2 control-label">BUSINESS:</label>
                <div class="col-lg-8">
                  <textarea name="used_business" rows=8 cols=100 wrap="soft"><?php echo trim($business_text); ?> </textarea>
                </div>
              </div>
        </div>
      <div class="form-group">
	<center>
	  <button type="submit" class="btn btn-primary">Submit Used Lines</button>
	</center>
      </div>
      <input type="hidden" name="used_lines" id="used_lines" value="true">
      <input type="hidden" name="soft_ids" id="soft_ids" value="<?php echo "'".implode("','", array_unique($soft_ids))."'"; ?>">
      <input type="hidden" name="cat_id" id="cat_id" value="<?php echo $_GET['cat_id']; ?>">
    </form>
  </div>
</body>
</html>

<?php
exit;
}
?>

<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=utf-8">

<link rel="stylesheet" href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css">
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>

<script>
$(function() {
		<?php
		$query = "select name from software_category";
		$result = $connection->query($query);
		$cats ="[";

		while($row = $result->fetch_assoc()){
			$cats.= '"'.strtolower($row['name']).'",';
		}

		$cats = trim($cats, ",");
		$cats.=']';

		echo "  var availableSubs = ".$cats;
		?>

		$( "#cat_name" ).autocomplete({
			source: availableSubs
		});
	});
</script>
</head>

<body>

<table width="600">
<form action="<?php echo $_SERVER["PHP_SELF"]; ?>" method="get" enctype="multipart/form-data">
<div>Software Category Name: <input type="text" name="cat_name" id="cat_name"></div>
<tr>
<td>Submit</td>
<td><input type="submit" name="submit" /></td>
</tr>
</form>
</table>

<?php $connection->close(); ?>
