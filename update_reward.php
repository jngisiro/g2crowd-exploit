<?php
require_once('settings.php');

if ( !isset ( $connection ) ) {
	$connection = new mysqli( DB_HOST, DB_USER, DB_PASSWORD, G2_DB_NAME );
	if ( $connection->connect_error ) {
		die ( "Couldn't Connect To DB");
	}
}

echo 'starting rewards update '.date("Y-m-d").PHP_EOL;

$query = "select id from softwares";
if(!$result=$connection->query($query)){
	die("error getting ids");
}

while($row = $result->fetch_assoc()){
	get_reward($row['id']);
}

function get_reward($product_id){
	global $connection;

	$ch = curl_init();

	$ua = "Mozilla/5.0 (Linux; U; Android 4.0.3; de-ch; HTC Sensation Build/IML74K) AppleWebKit/534.30 (KHTML, like Gecko) Version/4.0 Mobile Safari/534.30";
	curl_setopt($ch, CURLOPT_USERAGENT, $ua);

	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
	curl_setopt($ch, CURLOPT_AUTOREFERER, true);
	curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
	curl_setopt($ch, CURLOPT_ENCODING, '');
	curl_setopt($ch, CURLOPT_TIMEOUT, 20);

	curl_setopt($ch, CURLOPT_URL,"https://www.g2crowd.com/stacks/use/products");

	//curl_setopt($ch, CURLOPT_HEADER, true);
	curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );

	curl_setopt($ch, CURLOPT_PROXY, '127.0.0.1:9050');
	curl_setopt( $ch, CURLOPT_PROXYTYPE, CURLPROXY_SOCKS5);

	curl_setopt($ch, CURLOPT_POST, true);

	curl_setopt( $ch, CURLOPT_POSTFIELDS, json_encode(array("product_id"=> $product_id)));
	curl_setopt( $ch, CURLOPT_HTTPHEADER, get_browser_headers());

	$server_output = curl_exec ($ch);

	if(!isJson($server_output)){
		return;
	}

	echo $server_output.PHP_EOL;

	$server_output = json_decode($server_output, true);

	$reward = ltrim($server_output['reward'], '$');
	if(!empty($reward)){
		$query = "update softwares set reward='$reward' where id='$product_id'";
		if(!$connection->query($query)){
			die("error");
		}
	}

	curl_close ($ch);
	sleep(10);
}

function isJson($string) {
	json_decode($string);
	return (json_last_error() == JSON_ERROR_NONE);
}

function get_browser_headers(){
	$header = array();
	$header[] = 'Accept: text/xml,application/xml,application/xhtml+xml,text/html,application/json;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5';
	$header[] = 'Content-Type:application/json';
	$header[] = 'Cache-Control: max-age=0';
	$header[] = 'Connection: keep-alive';
	$header[] = 'Keep-Alive: 300';
	$header[] = 'Accept-Charset: ISO-8859-1,utf-8;q=0.7,*;q=0.7';
	$header[] = 'Accept-Language: en-us,en;q=0.5';
	$header[] = 'Pragma: ';

	return $header;
}

?>
